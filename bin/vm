#!/usr/bin/env python3
"""
vm ‚Äî Generic QEMU/KVM Virtual Machine Helper
Wraps 'virsh' and 'virt-install' for smoother development workflows.
"""

import os
import sys
import subprocess
import argparse
import shutil

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

def run(cmd, check=True, capture=False):
    """Run shell command."""
    if not capture:
        print(f"‚Üí {' '.join(cmd)}")
    try:
        result = subprocess.run(cmd, check=check, capture_output=capture, text=True)
        return result.stdout.strip() if capture else None
    except subprocess.CalledProcessError as e:
        if check:
            print(f"‚ùå Command failed: {' '.join(cmd)}", file=sys.stderr)
            if capture:
                print(e.stderr, file=sys.stderr)
            sys.exit(1)
        raise e

def get_arg_or_env(args, key, env_var):
    """Resolve value from argument or environment variable."""
    val = getattr(args, key, None)
    if val:
        return val
    return os.environ.get(env_var)

def require_vm_name(args):
    name = get_arg_or_env(args, "name", "VM_NAME")
    if not name:
        print("‚ùå Error: No VM name specified.", file=sys.stderr)
        print("  Use -n <name> or set VM_NAME environment variable.", file=sys.stderr)
        sys.exit(1)
    return name

def require_user(args):
    user = get_arg_or_env(args, "user", "VM_USER")
    if not user:
        print("‚ùå Error: No VM user specified for SSH.", file=sys.stderr)
        print("  Use -u <user> or set VM_USER environment variable.", file=sys.stderr)
        sys.exit(1)
    return user

def get_vm_ip(vm_name):
    """Extracts IP address using virsh domifaddr."""
    # 1. Try Guest Agent (Most reliable)
    try:
        out = run(["virsh", "domifaddr", vm_name, "--source", "agent"], capture=True, check=False)
        if out:
            for line in out.splitlines():
                if "ipv4" in line:
                    parts = line.split()
                    return parts[-1].split('/')[0]
    except:
        pass

    # 2. Try ARP Lease (Fallback - works without agent)
    try:
        out = run(["virsh", "domifaddr", vm_name, "--source", "lease"], capture=True, check=False)
        if out:
            for line in out.splitlines():
                if "ipv4" in line:
                    parts = line.split()
                    return parts[-1].split('/')[0]
    except:
        pass
    return None

# ------------------------------------------------------------
# Commands
# ------------------------------------------------------------

def cmd_list(_args):
    """List all VMs."""
    run(["virsh", "list", "--all"])

def cmd_start(args):
    name = require_vm_name(args)
    state = run(["virsh", "domstate", name], capture=True)
    if "running" in state:
        print(f"‚úÖ {name} is already running.")
    else:
        run(["virsh", "start", name])
        print(f"üöÄ Started {name}.")

def cmd_stop(args):
    name = require_vm_name(args)
    run(["virsh", "shutdown", name])
    print(f"üõë Shutdown signal sent to {name}.")

def cmd_force_stop(args):
    name = require_vm_name(args)
    run(["virsh", "destroy", name])
    print(f"üíÄ Forcefully stopped {name}.")

def cmd_delete(args):
    """Permanently delete the VM and its storage."""
    name = require_vm_name(args)

    print(f"‚ö†Ô∏è  WARNING: This will PERMANENTLY DELETE '{name}' and all its disk images.")
    confirm = input(f"Type '{name}' to confirm: ")

    if confirm != name:
        print("‚ùå Confirmation failed. Aborting.")
        sys.exit(1)

    state = run(["virsh", "domstate", name], capture=True)
    if "running" in state:
        print(f"Stopping {name}...")
        run(["virsh", "destroy", name], check=False)

    print(f"üóëÔ∏è  Deleting {name}...")
    run(["virsh", "undefine", name, "--remove-all-storage", "--nvram"])
    print(f"‚úÖ {name} has been deleted.")

def cmd_create(args):
    """Create a new VM using virt-install."""
    name = require_vm_name(args)

    # Check if VM already exists
    if run(["virsh", "dominfo", name], check=False, capture=True):
        print(f"‚ùå VM '{name}' already exists.", file=sys.stderr)
        sys.exit(1)

    # Defaults (Minimal Specs)
    ram = args.ram or "1024"  # 1GB RAM
    vcpus = args.cpu or "1"   # 1 CPU Core
    disk_size = args.disk or "8" # 8GB Disk

    print(f"üî® Preparing to create VM '{name}'...")
    print(f"   Specs: {ram}MB RAM, {vcpus} CPU, {disk_size}GB Disk")

    # Install Source
    if args.iso:
        location_args = ["--cdrom", os.path.abspath(args.iso)]
        print(f"   Source: ISO ({args.iso})")
    else:
        # Default to Debian 12 NetInst if no ISO provided
        print("   Source: Debian 12 (Bookworm) Network Install")
        location_args = ["--location", "http://deb.debian.org/debian/dists/bookworm/main/installer-amd64/"]

    # Construct virt-install command
    cmd = [
        "virt-install",
        "--name", name,
        "--memory", ram,
        "--vcpus", vcpus,
        "--disk", f"size={disk_size}",
        "--os-variant", "debian12",
        "--network", "network=default",
        "--graphics", "spice",
        "--video", "qxl",
        "--channel", "spicevmc",
        "--console", "pty,target_type=serial"
    ] + location_args

    print("\nüöÄ Launching installer... (A graphical window should appear)")
    try:
        subprocess.run(cmd, check=True)
        print(f"\n‚úÖ VM '{name}' created successfully.")
        print("üëâ TIP: Remember to create a user during install that matches your 'vm setup' user.")
    except subprocess.CalledProcessError:
        print("\n‚ùå Creation failed.", file=sys.stderr)
        sys.exit(1)

def cmd_status(args):
    name = require_vm_name(args)
    state = run(["virsh", "domstate", name], capture=True)
    ip = get_vm_ip(name)
    ip_str = ip if ip else "Unknown (Run 'vm setup' to install agent?)"
    print(f"VM:     {name}")
    print(f"State:  {state}")
    print(f"IP:     {ip_str}")

def cmd_ip(args):
    name = require_vm_name(args)
    ip = get_vm_ip(name)
    if ip:
        print(ip)
    else:
        print(f"‚ùå Could not detect IP for {name}.", file=sys.stderr)
        sys.exit(1)

def cmd_ssh(args):
    name = require_vm_name(args)
    user = require_user(args)
    ip = get_vm_ip(name)

    if not ip:
        print(f"‚ùå Cannot find IP for {name}. Ensure it is running.", file=sys.stderr)
        sys.exit(1)

    print(f"üîå Connecting to {user}@{ip}...")
    ssh_cmd = ["ssh", f"{user}@{ip}"] + args.extra
    os.execvp("ssh", ssh_cmd)

def cmd_deploy(args):
    name = require_vm_name(args)
    user = require_user(args)
    ip = get_vm_ip(name)

    if not ip:
        print(f"‚ùå Cannot find IP for {name}.", file=sys.stderr)
        sys.exit(1)

    script = args.script
    if not os.path.isfile(script):
        print(f"‚ùå Deployment script not found: {script}", file=sys.stderr)
        sys.exit(1)

    print(f"üì¶ Running {script} against {name} ({ip})...")
    cmd = [os.path.abspath(script), user, ip] + args.extra
    subprocess.run(cmd)

def cmd_setup(args):
    name = require_vm_name(args)
    user = require_user(args)

    print(f"üîç Attempting to find IP for {name} via ARP lease...")
    ip = get_vm_ip(name)

    if not ip:
        print(f"‚ùå Could not detect IP via ARP.", file=sys.stderr)
        sys.exit(1)

    print(f"üõ†Ô∏è  Installing qemu-guest-agent on {name} ({ip})...")

    commands = [
        "sudo apt update",
        "sudo apt install -y qemu-guest-agent",
        "sudo systemctl enable --now qemu-guest-agent",
        "echo '‚úÖ Agent installed successfully.'"
    ]
    remote_cmd = " && ".join(commands)

    ssh_cmd = ["ssh", f"{user}@{ip}", "-t", remote_cmd]
    try:
        subprocess.run(ssh_cmd, check=True)
    except subprocess.CalledProcessError:
        print("‚ùå Setup failed.", file=sys.stderr)

# ------------------------------------------------------------
# Main
# ------------------------------------------------------------
def main():
    parser = argparse.ArgumentParser(description="Generic VM Manager")

    # Global arguments
    parser.add_argument("-n", "--name", help="VM Name (overrides VM_NAME env var)")
    parser.add_argument("-u", "--user", help="VM User (overrides VM_USER env var)")

    subparsers = parser.add_subparsers(dest="command")

    # Lifecycle
    subparsers.add_parser("list", help="List all VMs")
    subparsers.add_parser("start", help="Start the VM")
    subparsers.add_parser("stop", help="Graceful shutdown")
    subparsers.add_parser("kill", help="Force power off")
    subparsers.add_parser("delete", help="Permanently delete VM")
    subparsers.add_parser("status", help="Show info")
    subparsers.add_parser("ip", help="Print IP address")

    # Creation
    create_p = subparsers.add_parser("create", help="Create a new VM")
    create_p.add_argument("--ram", help="RAM in MB (default 1024)")
    create_p.add_argument("--cpu", help="Number of VCPUs (default 1)")
    create_p.add_argument("--disk", help="Disk size in GB (default 8)")
    create_p.add_argument("--iso", help="Path to local ISO (overrides network install)")

    # Tools
    subparsers.add_parser("setup", help="Install qemu-guest-agent on VM")
    ssh_p = subparsers.add_parser("ssh", help="SSH into VM")
    ssh_p.add_argument("extra", nargs=argparse.REMAINDER, help="Commands to run")

    dep_p = subparsers.add_parser("deploy", help="Run a deploy script")
    dep_p.add_argument("script", help="Path to deployment script")
    dep_p.add_argument("extra", nargs=argparse.REMAINDER, help="Extra args")

    args = parser.parse_args()

    if args.command is None:
        if args.name or os.environ.get("VM_NAME"):
            cmd_status(args)
        else:
            parser.print_help()
        sys.exit(0)

    # Dispatch
    cmds = {
        "list": cmd_list, "start": cmd_start, "stop": cmd_stop,
        "kill": cmd_force_stop, "delete": cmd_delete, "create": cmd_create,
        "status": cmd_status, "ip": cmd_ip, "ssh": cmd_ssh,
        "deploy": cmd_deploy, "setup": cmd_setup,
    }

    if args.command in cmds:
        cmds[args.command](args)
    else:
        parser.print_help()

if __name__ == "__main__":
    if not shutil.which("virsh"):
        print("‚ùå Error: 'virsh' not found. Install libvirt-clients.", file=sys.stderr)
        sys.exit(1)
    main()
