#!/usr/bin/env bash
set -euo pipefail

# -----------------------------
# Default target directory
# -----------------------------
TARGET_DIR="${1:-$HOME}"

# -----------------------------
# Absolute path to this script
# -----------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SOURCE_BIN_DIR="$SCRIPT_DIR/bin"
DOTFILES_DIR="$SCRIPT_DIR/dotfiles"

# -----------------------------
# Sync dotfiles via Python
# -----------------------------
echo "Syncing dotfiles to $TARGET_DIR..."
if ! python3 "$SCRIPT_DIR/bin/sync-dotfiles" "$TARGET_DIR"; then
    echo "Error: sync-dotfiles failed. Aborting."
    exit 1
fi

# -----------------------------
# Create dotfiles alias
# -----------------------------

BASHRC_D_DIR="$HOME/.bashrc.d"
ALIAS_FILE="$BASHRC_D_DIR/dotfiles_alias"

mkdir -p "$BASHRC_D_DIR"

echo "Creating dotfiles alias at '$ALIAS_FILE'."
cat <<EOF > "$ALIAS_FILE"
# Alias to quickly jump to dotfiles directory
alias dotfiles='cd $SCRIPT_DIR'
EOF

echo "Done. '$ALIAS_FILE' created."

# -----------------------------
# Sync custom scripts
# -----------------------------
TARGET_BIN_DIR="$TARGET_DIR/bin"

echo "Syncing custom scripts to $TARGET_BIN_DIR..."

mkdir -p "$TARGET_BIN_DIR"
# Loop through all files in the source bin directory
for script_path in "$SOURCE_BIN_DIR"/*; do
    # Check if the glob found any files
    if [ -e "$script_path" ]; then
        script_name=$(basename "$script_path")
        target_path="$TARGET_BIN_DIR/$script_name"

        # Make the source script executable before linking
        chmod +x "$script_path"

        echo "  -> Linking $script_name"
        # Create or update the symlink, forcing overwrite
        ln -sf "$script_path" "$target_path"
    fi
done

# -----------------------------
# Git configuration
# -----------------------------
if command -v git &> /dev/null; then
    echo "Configuring global Git settings..."

    git config --global user.name "Ishmael Aqsar"
    git config --global user.email "ishmael-dev@aqsar.dev"
    git config --global core.excludesfile "$HOME/.gitignore_global"
    git config --global core.attributesfile "$HOME/.gitattributes"

    echo "Git configuration complete."
else
    echo "Git not found. Skipping git configuration."
fi

echo "Dotfiles installation complete."
